<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard IoT - Monitoring Suhu & Pakan Ikan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-b from-blue-50 to-white min-h-screen text-gray-800">

  <div class="max-w-5xl mx-auto px-4 py-6">
    <!-- Judul -->
    <h1 class="text-4xl font-bold text-center mb-8 text-blue-800">📡 Monitoring IoT: Suhu & Pakan Ikan</h1>

    <!-- ALERT -->
    <div id="alertBox" class="hidden mb-4 p-4 rounded-lg shadow text-white font-semibold text-center"></div>

    <!-- Ringkasan Data -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
      <div class="bg-white rounded-xl shadow-lg p-5 text-center">
        <h2 class="text-gray-500 mb-1">Suhu Air</h2>
        <p id="current-suhu" class="text-3xl font-extrabold text-red-500">-- °C</p>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-5 text-center">
        <h2 class="text-gray-500 mb-1">Jam (RTC)</h2>
        <p id="current-jam" class="text-3xl font-extrabold text-black">--:--</p>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-5 text-center">
        <h2 class="text-gray-500 mb-1">Kapasitas Pakan</h2>
        <p id="current-pakan" class="text-3xl font-extrabold text-blue-600">-- cm</p>
      </div>
    </div>

    <!-- Tombol Aksi -->
    <div class="flex flex-wrap gap-4 justify-center mb-8">
      <button id="btnManual" class="bg-green-600 hover:bg-green-700 transition text-white px-6 py-2 rounded-lg shadow-md">
        🐟 Pakan Ikan Sekarang
      </button>
      <button id="toggleChart" class="bg-gray-700 hover:bg-gray-800 transition text-white px-6 py-2 rounded-lg shadow-md">
        📊 Tampilkan Riwayat
      </button>
    </div>

    <!-- Chart -->
    <div id="chartContainer" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow p-4">
          <canvas id="suhuChart"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <canvas id="pakanChart"></canvas>
        </div>
      </div>
      <div class="text-center mb-4">
        <p class="text-gray-600 text-sm">
          📈 Chart otomatis terupdate dengan data terbaru dan tersimpan permanent
        </p>
      </div>
    </div>

    <!-- Divider -->
    <div class="border-t pt-6 mb-6">
      <!-- Tambah Jadwal -->
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <h2 class="text-xl font-semibold mb-4">🕒 Tambah Jadwal Otomatis</h2>
        <form id="jadwalForm" class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
          <input type="time" name="jadwal" required class="border rounded p-2 w-40">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Tambah</button>
        </form>
      </div>

      <!-- Jadwal Tersimpan -->
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-xl font-semibold mb-4">🗓️ Jadwal Tersimpan</h2>
        <ul id="jadwalList" class="space-y-2"></ul>
      </div>
    </div>

    <!-- System Info -->
    <div class="mt-8 text-center text-gray-500 text-sm">
      <p>💡 Debug Console: <code>debugIoT()</code> | Data Interval: 3 menit | Auto-Sync: Aktif</p>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Inisialisasi Socket.IO
    const socket = io();
    const alertBox = document.getElementById('alertBox');

    // Variabel untuk chart dan persistent storage
    let suhuChart, pakanChart;
    
    // Persistent storage untuk chart data
    const STORAGE_KEY_SUHU = 'iot_chart_suhu_data';
    const STORAGE_KEY_PAKAN = 'iot_chart_pakan_data';
    const MAX_CHART_POINTS = 100;

    // Tracking untuk ESP32 status dan feeding (background only)
    let esp32Status = {
      connected: false,
      last_heartbeat: null,
      socket_connected: false,
      total_schedules: 0,
      last_executed: null
    };

    // Fungsi save/load chart data
    function saveChartData() {
      if (suhuChart && pakanChart) {
        const suhuData = {
          labels: suhuChart.data.labels,
          data: suhuChart.data.datasets[0].data
        };
        const pakanData = {
          labels: pakanChart.data.labels,
          data: pakanChart.data.datasets[0].data
        };
        
        try {
          window.chartStorage = window.chartStorage || {};
          window.chartStorage[STORAGE_KEY_SUHU] = JSON.stringify(suhuData);
          window.chartStorage[STORAGE_KEY_PAKAN] = JSON.stringify(pakanData);
          console.log('💾 Chart data disimpan');
        } catch (e) {
          console.log('⚠️ Tidak bisa simpan chart data:', e);
        }
      }
    }

    function loadChartData() {
      try {
        window.chartStorage = window.chartStorage || {};
        const suhuData = window.chartStorage[STORAGE_KEY_SUHU];
        const pakanData = window.chartStorage[STORAGE_KEY_PAKAN];
        
        if (suhuData && pakanData && suhuChart && pakanChart) {
          const parsedSuhu = JSON.parse(suhuData);
          const parsedPakan = JSON.parse(pakanData);
          
          suhuChart.data.labels = parsedSuhu.labels || [];
          suhuChart.data.datasets[0].data = parsedSuhu.data || [];
          pakanChart.data.labels = parsedPakan.labels || [];
          pakanChart.data.datasets[0].data = parsedPakan.data || [];
          
          suhuChart.update('none');
          pakanChart.update('none');
          console.log('📊 Chart data dimuat dari storage');
          return true;
        }
      } catch (e) {
        console.log('⚠️ Error load chart data:', e);
      }
      return false;
    }

    // Minta izin notifikasi browser
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Fungsi utility
    function tampilkanAlert(pesan, warna) {
      alertBox.textContent = pesan;
      alertBox.className = `mb-4 p-4 rounded-lg shadow font-semibold text-center text-white bg-${warna}-600`;
      alertBox.classList.remove('hidden');
      setTimeout(() => alertBox.classList.add('hidden'), 5000);
    }

    function kirimNotifikasiBrowser(pesan) {
      if (Notification.permission === "granted") {
        new Notification("🐟 IoT Alert", { body: pesan });
      }
    }

    // Update status ESP32 di background (tanpa UI)
    function updateESP32Status() {
      const isHealthy = esp32Status.connected && esp32Status.socket_connected;
      console.log(`📡 ESP32 Status: ${isHealthy ? 'Healthy' : 'Issues'} | Socket: ${esp32Status.socket_connected} | Schedules: ${esp32Status.total_schedules}`);
    }

    // Socket.IO event handlers
    socket.on('connect', () => {
      console.log('✅ Socket.IO terhubung');
      loadCurrentData();
    });

    socket.on('disconnect', () => {
      console.log('❌ Socket.IO terputus');
    });

    socket.on('connect_error', (error) => {
      console.log('❌ Socket.IO connection error:', error);
      loadCurrentData();
    });

    // Timeout fallback
    setTimeout(() => {
      if (!socket.connected) {
        console.log('🔄 Socket.IO timeout, menggunakan HTTP polling');
        loadCurrentData();
        setInterval(loadCurrentData, 30000);
      }
    }, 3000);

    socket.on('sensor-update', (data) => {
      console.log('📊 Data sensor diterima:', data);
      updateDisplay(data);
    });

    // Handler untuk ESP32 heartbeat (background)
    socket.on('esp32-heartbeat', (data) => {
      esp32Status = {
        connected: true,
        last_heartbeat: new Date(),
        socket_connected: data.socket_connected,
        total_schedules: data.total_schedules,
        last_executed: data.last_executed,
        current_time: data.current_time
      };
      updateESP32Status();
      console.log('💓 ESP32 Heartbeat:', data);
    });

    // Handler untuk auto feeding notification
    socket.on('auto-feeding-triggered', (data) => {
      tampilkanAlert(`⏰ Feeding otomatis dijalankan pada ${data.schedule_time}`, 'blue');
      console.log('🍽️ Auto feeding triggered:', data);
    });

    // Handler untuk feeding execution dari ESP32
    socket.on('feeding-executed', (data) => {
      const msg = data.source === 'manual' ? 
        `🐟 Feeding manual berhasil (${data.time})` : 
        `⏰ Feeding otomatis berhasil (${data.time})`;
      tampilkanAlert(msg, 'green');
      console.log('✅ Feeding executed:', data);
    });

    // Handler untuk status jadwal update
    socket.on('jadwal-status-update', (data) => {
      console.log('📅 Jadwal status update:', data);
      ambilJadwal();
    });

    // Handler untuk display data (1 menit interval)
    socket.on('display-data', (data) => {
      console.log('📺 Display data diterima:', data);
      updateDisplay(data);
    });

    // Fungsi update display
    function updateDisplay(data) {
      // Update tampilan angka
      document.getElementById('current-suhu').textContent = `${data.suhu} °C`;
      document.getElementById('current-pakan').textContent = `${data.pakan_cm} cm`;
      document.getElementById('current-jam').textContent = data.waktu || '--:--';

      // Cek kondisi alert sesuai backend logic
      const suhuAbnormal = (data.suhu < 20 || data.suhu > 32);
      const pakanHabis = (data.pakan_cm > 12);

      if (suhuAbnormal && pakanHabis) {
        const msg = `🚨 KRITIS: Suhu ${data.suhu}°C + Pakan habis (${data.pakan_cm}cm) - ESP32 buzzer 2x beep`;
        tampilkanAlert(msg, 'red');
        kirimNotifikasiBrowser(msg);
      } else if (suhuAbnormal) {
        const msg = `⚠️ Suhu tidak normal: ${data.suhu} °C`;
        tampilkanAlert(msg, 'red');
        kirimNotifikasiBrowser(msg);
      } else if (pakanHabis) {
        const msg = `⚠️ Pakan habis: ${data.pakan_cm} cm`;
        tampilkanAlert(msg, 'yellow');
        kirimNotifikasiBrowser(msg);
      }

      // Update chart (hanya untuk data yang disimpan ke database, bukan display-only)
      if (suhuChart && pakanChart && !data.display_only) {
        const waktu = new Date(data.createdAt || Date.now()).toLocaleTimeString('id-ID', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        const lastLabel = suhuChart.data.labels[suhuChart.data.labels.length - 1];
        if (lastLabel !== waktu) {
          
          if (suhuChart.data.labels.length >= MAX_CHART_POINTS) {
            suhuChart.data.labels.shift();
            suhuChart.data.datasets[0].data.shift();
            pakanChart.data.labels.shift();
            pakanChart.data.datasets[0].data.shift();
          }

          suhuChart.data.labels.push(waktu);
          suhuChart.data.datasets[0].data.push(data.suhu);
          pakanChart.data.labels.push(waktu);
          pakanChart.data.datasets[0].data.push(data.pakan_cm);
          
          suhuChart.update('none');
          pakanChart.update('none');
          saveChartData();
          
          console.log(`📊 Chart updated: ${waktu} - Suhu: ${data.suhu}°C, Pakan: ${data.pakan_cm}cm`);
        }
      }
    }

    // Fungsi API calls
    async function loadCurrentData() {
      try {
        const response = await fetch('/api/sensor/current');
        if (response.ok) {
          const data = await response.json();
          console.log('📊 Data terbaru dimuat:', data);
          updateDisplay(data);
        }
      } catch (error) {
        console.error('❌ Error load data terbaru:', error);
      }
    }

    async function loadInitialChartData() {
      try {
        console.log('📊 Loading initial chart data...');
        
        const response = await fetch('/api/sensor/logs?jam=3');
        if (response.ok) {
          const logs = await response.json();
          console.log(`📈 Loaded ${logs.length} initial data points`);
          
          if (!suhuChart || !pakanChart) {
            console.log('❌ Chart belum diinisialisasi');
            return;
          }

          const recentLogs = logs.slice(0, MAX_CHART_POINTS).reverse();
          recentLogs.forEach(log => {
            const waktu = new Date(log.createdAt).toLocaleTimeString('id-ID', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            suhuChart.data.labels.push(waktu);
            suhuChart.data.datasets[0].data.push(log.suhu);
            pakanChart.data.labels.push(waktu);
            pakanChart.data.datasets[0].data.push(log.pakan_cm);
          });

          suhuChart.update();
          pakanChart.update();
          saveChartData();
          
          console.log(`✅ Chart initialized with ${recentLogs.length} data points`);
        }
      } catch (error) {
        console.error('❌ Error loading initial chart data:', error);
      }
    }

    // Event listeners
    document.getElementById('btnManual').addEventListener('click', async () => {
      try {
        const response = await fetch('/api/sensor/manual', { method: 'POST' });
        if (response.ok) {
          const result = await response.json();
          tampilkanAlert(`🐟 ${result.message} - ESP32 buzzer ${result.buzzer}`, 'green');
          console.log('📤 Manual feeding request sent:', result);
        }
      } catch (error) {
        tampilkanAlert('❌ Gagal mengirim pakan manual', 'red');
      }
    });

    document.getElementById('toggleChart').addEventListener('click', () => {
      const chart = document.getElementById('chartContainer');
      chart.classList.toggle('hidden');
      
      if (!chart.classList.contains('hidden')) {
        document.getElementById('toggleChart').textContent = '❌ Sembunyikan Riwayat';
        initCharts();
        
        setTimeout(() => {
          if (!loadChartData()) {
            loadInitialChartData();
          }
        }, 100);
      } else {
        document.getElementById('toggleChart').textContent = '📊 Tampilkan Riwayat';
      }
    });

    document.getElementById('jadwalForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const jadwal = form.get('jadwal');
      
      try {
        const response = await fetch('/api/sensor/jadwal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jadwal })
        });
        
        if (response.ok) {
          tampilkanAlert(`✅ Jadwal ${jadwal} berhasil ditambahkan`, 'green');
          e.target.reset();
          ambilJadwal();
        } else {
          const error = await response.json();
          tampilkanAlert(`❌ ${error.error}`, 'red');
        }
      } catch (error) {
        tampilkanAlert('❌ Gagal menambahkan jadwal', 'red');
      }
    });

    // Fungsi jadwal
    async function ambilJadwal() {
      try {
        const res = await fetch('/api/sensor/jadwal');
        const data = await res.json();
        const list = document.getElementById('jadwalList');
        list.innerHTML = '';
        
        if (data.length === 0) {
          list.innerHTML = '<li class="text-gray-500 italic">Belum ada jadwal</li>';
          return;
        }
        
        data.forEach(j => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
              <span class="font-medium">⏰ ${j}</span>
              <button onclick="hapusJadwal('${j}')" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded transition">Hapus</button>
            </div>`;
          list.appendChild(li);
        });
      } catch (error) {
        console.error('❌ Error ambil jadwal:', error);
      }
    }

    async function hapusJadwal(jadwal) {
      try {
        const response = await fetch('/api/sensor/jadwal', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jadwal })
        });
        
        if (response.ok) {
          tampilkanAlert(`🗑️ Jadwal ${jadwal} dihapus`, 'yellow');
          ambilJadwal();
        }
      } catch (error) {
        tampilkanAlert('❌ Gagal menghapus jadwal', 'red');
      }
    }

    // Inisialisasi chart
    function initCharts() {
      if (suhuChart && pakanChart) return;

      suhuChart = new Chart(document.getElementById('suhuChart'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Suhu (°C)',
            data: [],
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: { 
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Grafik Suhu Air'
            }
          },
          scales: { 
            x: { 
              display: true,
              title: {
                display: true,
                text: 'Waktu'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Suhu (°C)'
              }
            }
          }
        }
      });

      pakanChart = new Chart(document.getElementById('pakanChart'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Pakan (cm)',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: { 
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Grafik Ketinggian Pakan'
            }
          },
          scales: { 
            x: { 
              display: true,
              title: {
                display: true,
                text: 'Waktu'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Ketinggian (cm)'
              }
            }
          }
        }
      });
    }

    // Inisialisasi awal
    ambilJadwal();
    
    // Monitor ESP32 connection status (background)
    setInterval(() => {
      if (esp32Status.last_heartbeat) {
        const timeSinceLastHeartbeat = Date.now() - esp32Status.last_heartbeat.getTime();
        if (timeSinceLastHeartbeat > 60000) { // 1 menit tanpa heartbeat
          esp32Status.connected = false;
          updateESP32Status();
        }
      }
    }, 30000);

    console.log('🚀 Sistema IoT siap - Monitor ESP32 aktif (background)');
    
    // Debug function untuk monitoring
    window.debugIoT = function() {
      console.log('=== DEBUG INFO ===');
      console.log('ESP32 Status:', esp32Status);
      console.log('Socket Connected:', socket.connected);
      console.log('Chart Points:', suhuChart ? suhuChart.data.labels.length : 0);
      
      // Fetch debug info dari backend
      fetch('/api/sensor/debug')
        .then(r => r.json())
        .then(data => {
          console.log('Backend Debug:', data);
        })
        .catch(e => console.log('Debug fetch error:', e));
    };
    
    console.log('🔧 Debug function available: debugIoT()');
  </script>
</body>
</html>